#!/bin/sh

dotfiles_dir=$DOTFILES_DIR
home_path=$HOME_PATH
: ${dotfiles_dir:="~/dotfiles"}
: ${home_path:="~/"}

platform=`uname`

command -v stow >/dev/null 2>&1 || { echo >&2 "GNU stow is not installed.  Aborting."; exit 1; }
if [ "$platform" = "Darwin" ]; then
  command -v brew >/dev/null 2>&1 || { echo >&2 "brew is not installed.  Aborting."; exit 1; }
  command -v gfind >/dev/null 2>&1 || { echo >&2 "brew findutils is not installed.  Aborting."; exit 1; }
  alias find='gfind'
fi

function Dotphile__printConfig() {
  echo dotfiles_dir=$dotfiles_dir
  echo home_path=$home_path
}

function Dotphile__add() {
  package=$1
  config=$2
  PACKAGE_ROOT=~/dotfiles/$package
  CONFIG_ROOT=$config
  DOTFILES_PACKAGE_CONFIG_ROOT=${CONFIG_ROOT#~/}
  PACKAGE_CONFIGURATION_ROOT=$PACKAGE_ROOT/$DOTFILES_PACKAGE_CONFIG_ROOT
  echo mkdir -p $(dirname $PACKAGE_CONFIGURATION_ROOT)
  echo mv $config $(dirname $PACKAGE_CONFIGURATION_ROOT)
}

function Dotphile__link() {
  echo stow $1 --dir ~/dotfiles
}

function Dotphile__linkall() {
  packages=$(find ~/dotfiles -maxdepth 1 -mindepth 1 -type d -printf '%f\n' | egrep -v '^\..*$')
  for package in $packages; do
    Dotphile__link $package
  done
}

function Dotphile__unlink() {
  echo stow --dir ~/dotfiles --delete $1
}

args=`getopt clau: $*`
if [ $# -eq 0 ]; then
  echo "Usage: ..."
  echo "-c"
  echo "--config"
  echo "    print the current configuration"
  echo "-l"
  echo "--link"
  echo "    symlink all dotfiles"
  echo "-a"
  echo "--add"
  echo "    store a configuration in the dotfiles folder and symlink it back to its original location"
  echo "-u"
  echo "--unlink"
  echo "    unlink a dotfile"
  exit 2
fi

if [ ! -d ~/dotfiles ]; then
  git clone git@github.com:pklingem/dotfiles ~/dotfiles
fi

set -- $args

for i
do
  case "$i"
  in
    -c|--config)
      Dotphile__printConfig

      shift;;
    -l|--link)
      Dotphile__linkall

      shift;;
    -a|--add)
      Dotphile__add $3 $4
      Dotphile__link $3

      shift; shift;
      ;;
    -u|--unlink)
      package="$2"; shift;

      Dotphile__unlink $package

      shift;;
    --)
      shift; break;;
  esac
done
