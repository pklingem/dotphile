#!/bin/sh

platform=`uname`

command -v stow >/dev/null 2>&1 || { echo >&2 "GNU stow is not installed.  Aborting."; exit 1; }
if [ "$platform" = "Darwin" ]; then
  command -v brew >/dev/null 2>&1 || { echo >&2 "brew is not installed.  Aborting."; exit 1; }
  command -v gfind >/dev/null 2>&1 || { echo >&2 "brew findutils is not installed.  Aborting."; exit 1; }
  alias find='gfind'
fi

# Use DOTPHILE_PATH environment variable or default to ~/dotfiles
DOTFILES_DIR="${DOTPHILE_PATH:-$HOME/dotfiles}"

# Use DOTPHILE_GIT_REPO environment variable or default to pklingem/dotfiles
DOTFILES_GIT_REPO="${DOTPHILE_GIT_REPO:-git@github.com:pklingem/dotfiles}"

add()
{
  package=$1
  config=$2
  PACKAGE_ROOT=$DOTFILES_DIR/$package
  CONFIG_ROOT=$config
  DOTFILES_PACKAGE_CONFIG_ROOT=${CONFIG_ROOT#~/}
  PACKAGE_CONFIGURATION_ROOT=$PACKAGE_ROOT/$DOTFILES_PACKAGE_CONFIG_ROOT
  mkdir -p $(dirname $PACKAGE_CONFIGURATION_ROOT)
  mv $config $(dirname $PACKAGE_CONFIGURATION_ROOT)
}

link()
{
  if ! stow $1 -d $DOTFILES_DIR 2>&1; then
    echo >&2 "Error: Failed to link package '$1'. There may be conflicts with existing files."
    echo >&2 "Run 'stow $1 -d $DOTFILES_DIR -n' to see what would be done."
    return 1
  fi
  echo "Successfully linked package '$1'"
}

updateSubmodules()
{
  if ! (cd $DOTFILES_DIR && git submodule init && git submodule update); then
    echo >&2 "Warning: Failed to update git submodules"
    return 1
  fi
}

linkAll()
{
  echo "Linking all packages from $DOTFILES_DIR..."
  failed_packages=""

  find $DOTFILES_DIR -maxdepth 1 -mindepth 1 -type d -printf '%f\n' |\
    grep -E -v '^\..*$' |\
    while read package; do
      if stow "$package" -d $DOTFILES_DIR 2>&1; then
        echo "  ✓ Linked $package"
      else
        echo "  ✗ Failed to link $package" >&2
        failed_packages="$failed_packages $package"
      fi
    done

  if [ -n "$failed_packages" ]; then
    echo >&2 "Warning: Some packages failed to link:$failed_packages"
    echo >&2 "There may be conflicts with existing files."
  fi
}

args=`getopt la: $*`
if [ $# -eq 0 ]; then
  echo "Usage: ..."
  echo "-l"
  echo "--link"
  echo "    symlink all dotfiles"
  echo "-a"
  echo "--add"
  echo "    store a configuration in the dotfiles folder and symlink it back to its original location"
  exit 2
fi

if [ ! -d $DOTFILES_DIR ]; then
  git clone $DOTFILES_GIT_REPO $DOTFILES_DIR
fi

set -- $args

for i
do
  case "$i"
  in
    -l|--link)
      updateSubmodules
      linkAll

      shift;;
    -a|--add)
      package="$2"; shift; config="$3"; shift;

      add $package $config
      link $package

      shift;;
    --)
      shift; break;;
  esac
done
